## ✨ Table of Contents
- [Overview](#overview)
- [Features](#features)
- [Installation](#installation)
- [Assistant Setup](#assistant-setup)
- [Usage](#usage)
- [Project Structure](#project-structure)
- [Tech Stack](#tech-stack)

---

## Overview

This project is a Telegram bot powered by the OpenAI Assistants API that supports multi-turn conversations with context preservation.


It offers several options for interacting with the intelligent assistant:

- **Random Trivia GPT Assistant** — 
provides fascinating and surprising technical facts from science, history, pop culture and technology. The answers are concise, funny and will interest everyone.
- **ChatGPT Assistant** — a short-response chatbot that answers user questions with 3–5 sentences, avoiding unnecessary introductions or verbose replies. Ideal for fast Q&A interactions.
- **Talk GPT Assistant** —  the chatbot imitates the manner and style of conversation of several famous personalities. Users can choose to talk to Albert Einstein, Freddie Mercury, Stephen King, and Napoleon Bonaparte.
- **Quiz Assistant** — the user selects a topic, receives a multiple-choice question generated by an OpenAI assistant,
and gets feedback based on their answer. The user's score is tracked during the session.
- **Translator Assistant** — the chatbot translates the user's text into the selected language. The content is kept as close to the original as possible by using the GPT language model.
- **Resume Assistant** — the chatbot collects information from the user about education, work experience, skills...
Based on the received data, it generates a resume template and sends it to the user in PDF or DOCX format

Behind the scenes, the bot uses:
- **OpenAI Threads API** to maintain contextual conversations per user and mode.
- **SQLite** as a lightweight storage for threads and messages.
- **Custom assistant management CLI** for creating, listing, updating, and deleting assistants directly via terminal.

This design allows each Telegram user to have separate conversation threads for each interaction mode. You can also view full assistant histories or clear them if needed.

--- 

## Features

- **📚 Fact Mode**  

  Sends a short and surprising technical trivia fact from domains like science, history, culture, or technology. The assistant is trained to respond with fun, beginner-friendly facts using Telegram-compatible HTML formatting.

- **💻 GPT Mode** 

  Allows freeform chatting with a concise-response assistant. Replies are short (2–4 sentences), skip unnecessary introductions, and include HTML formatting (e.g. `<b>`, `<i>`, `<code>`) for a polished user experience.

- **❓ Quiz Mode**

  Enables users to take a quiz on few topics like science, sport, art and cinema. Each quiz consists of  short, clear multiple-choice questions generated by an OpenAI Assistant. The bot keeps track of the user's answers, provides instant feedback after each question, and shows the final score at the end. All interactions are stored in the local SQLite database to preserve quiz history and context.

- **🗣 Talk Mode**

  With this mode, the user can talk to a famous personality. Ask their questions and get an answer that is as mysterious as Stephen King or as decisive as Napoleon.

- **🔄 Translator Mode**
 
  The user can send a text message and select a language, and chatGPT will translate the text with maximum accuracy, taking into account the specifics of the language.

- **📜 Resume Mode**

  With this mode, the user can receive a file with a professional resume in PDF or DOCX format. To do this, you need to send several messages with information about yourself. The bot provides the ability to edit the information if necessary.

- **💡 Multi-turn Conversations**  

  Each user gets persistent threads for each mode. All messages are stored in a local **SQLite** database for context tracking and future retrieval, allowing seamless back-and-forth interaction.

- **🔧 Assistant Lifecycle via CLI**  

  A built-in command-line tool (`assistant_manager.py`) lets you easily create, update, list, or delete OpenAI Assistants. This makes it simple to manage prompt versions or test assistant behavior during development.

- **💯 Robust Error Handling & Retry Logic**  

  Includes smart retrying for OpenAI API calls when temporary issues occur (e.g., server errors or parallel run conflicts), along with detailed logging for troubleshooting.

---


## Installation

Follow the steps below to set up the project locally.

### 1. Clone the repository

```bash
git clone https://github.com/mileshkin89/smart_tg_bot.git
cd smart_tg_bot
```

### 2. Create and activate a virtual environment

<details>
<summary>Linux / macOS</summary>

```bash
python -m venv .venv
source .venv/bin/activate
```

</details>

<details>
<summary>Windows</summary>

```bash
python -m venv .venv
.venv\Scripts\activate
```

</details>

---

### 3. Install Poetry

If you don’t have [Poetry](https://python-poetry.org/) installed, you can install it with:

```bash
pip install poetry
```

---

### 4. Install project dependencies

```bash
poetry install
```

---

### 5. Configure environment variables

1. **Copy the sample file**:

   ```bash
   cp .env.sample .env
   ```

2. **Open `.env` and fill in your credentials**:

   ```env
    OPENAI_API_KEY=<your_openai_api_key>
    TG_BOT_API_KEY=<your_tg_bot_api_key>
    AI_ASSISTANT_RANDOM_MILESHKIN_ID=<ID of assistant created with 'random.txt'>
    AI_ASSISTANT_GPT_MILESHKIN_ID=<ID of assistant created with 'gpt.txt'>
    AI_ASSISTANT_TALK_EINSTEIN_MILESHKIN_ID=<ID of assistant created with 'einstein.txt'>
    AI_ASSISTANT_TALK_KING_MILESHKIN_ID=<ID of assistant created with 'king.txt'>
    AI_ASSISTANT_TALK_NAPOLEON_MILESHKIN_ID=<ID of assistant created with 'napoleon.txt'>
    AI_ASSISTANT_TALK_MERCURY_MILESHKIN_ID=<ID of assistant created with 'mercury.txt'>
    AI_ASSISTANT_QUIZ_MILESHKIN_ID=<ID of assistant created with 'quiz.txt'>
    AI_ASSISTANT_TRANSLATE_MILESHKIN_ID=<ID of assistant created with 'translate.txt'>
    AI_ASSISTANT_RESUME_MILESHKIN_ID=<ID of assistant created with 'resume.txt'>
   ```

---

### 6. Where to get the keys?

- 🔑 **OpenAI API Key**  
  Create an account or log in at [platform.openai.com](https://platform.openai.com/), then go to **API Keys** under your account settings and generate a key.

- 🤖 **Telegram Bot API Key**  
  Open [@BotFather](https://t.me/BotFather) in Telegram, use `/newbot`, and follow the prompts to create your bot and get the token.

- 🧠 **Assistant IDs**  
  After launching the bot, you must create two assistants (one for fun facts, one for chat) using the CLI tool (described in the next section). Their `id`s will be saved and used in the `.env` file.

---

## Assistant Setup

To interact with OpenAI Assistants, you first need to **create and configure assistants** via the included CLI tool.

> 📍 Navigate to the directory before running the CLI:
```bash
cd src/services/chatgpt
```

---

### ✅ Creating Assistants

You’ll need few assistants:
1. **Random** – for surprising fact generation in `/random` mode.
2. **GPT** – for concise GPT-style answers in `/gpt` mode.
3. **TalkEinstein** – for talking to Albert Einstein in `/talk` mode.
4. **TalkKing** – for talking to Stephen Kin in `/talk` mode.
5. **TalkNapoleon** – for talking to Napoleon Bonaparte in `/talk` mode.
6. **TalkMercury** – for talking to Freddie Mercury in `/talk` mode.
7. **Quiz** – for quiz generation on few topics like science, sport, art and cinema in `/quiz` mode.
8. **Translate** – for translating text in `/translate` mode.
9. **Resume** – for creating resume in `/resume` mode

Create a new assistant with:

```bash
python assis_manager_client.py --create -n "Resume" -p resume
```

You will see the assistant ID in the console, for example:
```
Assistant created: asst_abc123456789 (Resume)
```

➡️ Copy this ID and paste it into your `.env` file:
```env
AI_ASSISTANT_RESUME_ID=asst_abc123456789
```

Repeat this process for the next assistant (e.g. `"TalkEinstein"` with `-p einstein`).

---

### 🛠 CLI Usage

Run the assistant manager tool with any of the following options:

```bash
python assistant_manager_cli.py [OPTIONS]
```

#### Available Options

| Option | Description |
|--------|-------------|
| `-h`, `--help` | Show help message and exit |
| `-l`, `--list` | List all existing assistants |
| `-c`, `--create` | Create a new assistant |
| `-n NAME`, `--name NAME` | Assistant name (required with `--create`) |
| `-p PROMPT`, `--prompt PROMPT` | Prompt filename from `resources/prompts` (required with `--create` or `--update`) |
| `-d ID`, `--delete ID` | Delete assistant by its ID |
| `-u ID`, `--update ID` | Update an assistant’s instructions by its ID |
| `-v`, `--version` | Show CLI tool version |

---

### 🔁 Examples

```bash
# List all assistants
python assis_manager_client.py --list

# Create assistant with name and prompt
python assis_manager_client.py --create -n "History Expert" -p history

# Update assistant’s instructions
python assis_manager_client.py --update asst_abc123456789 --prompt new_version

# Delete assistant
python assis_manager_client.py --delete asst_abc123456789
```

---

## Usage

To run the bot:

```bash
$ poetry run python src/main.py
```

---

### 💬 Interacting with the Bot

Once the bot is running:

- Open Telegram and find your bot using the `@YourBotUsername`
- Press **Start** or send the `/start` command to initialize the session
- You’ll see an interactive menu for different modes:
```
1. /start — bot main menu 😀
2. /random — get a random fact · 🧠
3. /gpt — ask ChatGPT a question · 🤖
4. /talk — chat with a famous personality · 👤
5. /quiz — test your knowledge ❓
6. /translate — translate text 🔄
7. /resume — Create resume 📜
```  

---

### 🧵 Conversation Persistence

- Each user and mode (e.g. `/gpt`, `/random`) has a dedicated **OpenAI thread**
- All user messages and assistant replies are stored in a local **SQLite database**
- When you return to a mode later, the conversation context is preserved
- Multi-turn interactions with memory are possible thanks to OpenAI’s **Assistant Threads**

---

### 🛑 Stop and Restart

You can stop the bot at any time (Ctrl+C), and restart it without losing prior chat history. Each assistant thread will continue from where the user left off.

---

## Project Structure
```
.
├── .env.sample                    # Example environment configuration
├── README.md                      # Project documentation
├── logs/
│   └── .gitkeep                   # Application log output
├── poetry.lock / pyproject.toml   # Poetry dependency and configuration files
├── resources/                     # Static content used by the bot
│   ├── images/                    # Images shown in bot UI 
│   ├── menus/                     # JSON files defining inline/reply keyboard menus per mode
│   ├── messages/                  # HTML welcome messages for each mode
│   └── prompts/                   # Prompt templates used to instruct OpenAI assistants
├── src/                           # Main application source code
│   ├── main.py                    # Entry point for launching the Telegram bot
│   ├── bot/
│   │   ├── __init__.py
│   │   ├── file_converter.py      # Converte text to file
│   │   ├── keyboards.py           # Inline and reply keyboard builders
│   │   ├── message_sender.py      # Utilities for sending formatted messages and images
│   │   ├── resource_loader.py     # Load static message/image/menu content from disk
│   │   ├── sanitize_html.py       # Sanitize messages from OpenAI client
│   │   └── commands/              # Async handlers for each mode
│   │       ├── __init__.py
│   │       ├── gpt.py             # Async handlers for GPT mode
│   │       ├── quiz.py            # Async handlers for Quiz mode
│   │       ├── random.py          # Async handlers for Random mode
│   │       ├── resume.py          # Async handlers for Resume mode
│   │       ├── start.py           # Async handlers for /start 
│   │       ├── talk.py            # Async handlers for Talk mode
│   │       └── translate.py       # Async handlers for Translate mode
│   ├── db/
│   │   ├── __init__.py
│   │   ├── enums.py              # Enums for mode and role definitions (SessionMode, MessageRole)
│   │   ├── initializer.py        # Database schema creation
│   │   └── repository.py         # DB access layer for threads and message history
│   ├── services/                 # Services connected to the bot
│   │   ├── __init__.py
│   │   └── chatgpt/
│   │       ├── __init__.py
│   │       ├── assis_manager_client.py      # CLI for assistant lifecycle management
│   │       └── client.py         # Async OpenAI client (threads, messages, runs)
│   └── settings/
│       ├── __init__.py
│       ├── config.py             # Loads configuration from .env using Pydantic
│       └── logging_config.py     # Logging setup and logger factory
└── storage/
    └── chat_sessions.db          # SQLite database storing threads and message history
```
---


## Tech Stack

This project is built with a modern asynchronous Python stack and integrates several key technologies:

### 🧠 Core Libraries

- **OpenAI Python SDK**  
  Used to interact with the OpenAI Assistants API (chat completions, thread management, message history).

- **python-telegram-bot**  
  Powerful and fully asynchronous framework for building Telegram bots.

- **aiosqlite**  
  Lightweight async wrapper for SQLite, used to store OpenAI thread IDs and full message history per user/mode.

- **aiofiles**  
  Async file I/O support, used for loading images, HTML messages, and prompt templates.
 

### ⚙️ Configuration & Environment

- **pydantic-settings**  
  Manages and validates environment variables with type hints.

- **python-dotenv**  
  Loads environment variables from `.env` files during development.

- **argparse**  
  Built-in Python library used for building the CLI tool to manage assistants (create, update, delete).

### 📦 Dependency Management

- **Poetry**  
  Handles virtual environments and dependency/version management in a clean and reproducible way.
 
